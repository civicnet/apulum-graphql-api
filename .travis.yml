
language: node_js
sudo: false
services:
  - postgresql
  - redis-server
before_script:
  - cp .env_sample .env
  - psql -c 'create database "apulum-graphql-api-test";' -U postgres
node_js:
  - 10
install:
  - yarn
env:
  DB_HOST=localhost
  DB_PORT=5432
  DB_USERNAME=postgres
  DB_PASSWORD=
  DB_DATABASE=apulum-graphql-api
  DB_TEST_DATABASE=apulum-graphql-api-test
  DB_SYNC=true
  DB_DROP_SCHEMA=true
  DB_DEBUG=false
  TEST_ENVIRONMENT=travis

jobs:
  include:
    - stage: Unit tests
      node_js: 10
      script:  yarn test:ci

    - stage: Test build and start
      node_js: 10
      script:  yarn build && yarn start:travis

    - stage: Produce coverage
      node_js: 10
      script: jest --coverage --forceExit && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
